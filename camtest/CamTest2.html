<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Cam + Capture dengan Frame Tetap</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{display:flex;flex-direction:column;gap:12px;align-items:center;padding:18px}
    .camera-wrap{position:relative;width:min(420px,90vw);background:#111;border-radius:8px;overflow:hidden}
    video{width:100%;height:auto;display:block}
    .overlay-img{position:absolute;inset:0;pointer-events:none;width:100%;height:100%;object-fit:cover}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:white;cursor:pointer}
    #result{max-width:90vw;border:1px solid #ddd;border-radius:6px}
    .small{font-size:13px;color:#444}
  </style>
</head>
<body>
  <h2>Open Cam â€” Ambil Foto dengan Frame Tetap</h2>

  <div class="camera-wrap">
    <video id="video" autoplay playsinline></video>
    <!-- Frame tetap -->
    <img id="templateOverlay" class="overlay-img" alt="frame tetap" src="frame.png" />
  </div>

  <div class="controls">
    <button id="startBtn">Minta Akses Kamera</button>
    <button id="switchBtn">Ganti Kamera (Depan/Belakang)</button>
    <button id="captureBtn">Ambil Foto</button>
    <a id="downloadBtn" style="display:none;" download="foto-frame.png">Download Foto</a>
  </div>

  <p class="small">Frame ini permanen dan tidak bisa diubah. Hasil foto hanya disimpan lokal.</p>

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="result" alt="hasil foto" />

  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const switchBtn = document.getElementById('switchBtn');
    const captureBtn = document.getElementById('captureBtn');
    const templateOverlay = document.getElementById('templateOverlay');
    const canvas = document.getElementById('canvas');
    const result = document.getElementById('result');
    const downloadBtn = document.getElementById('downloadBtn');

    let stream = null;
    let usingFacingMode = 'user'; // 'user' atau 'environment'
    let currentTemplateImage = null;

    // Muat frame tetap
    const frameImg = new Image();
    frameImg.onload = () => { currentTemplateImage = frameImg; };
    frameImg.src = 'frame.png';

    async function startCamera() {
      stopCamera();
      try {
        const constraints = { video: { facingMode: usingFacingMode }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
      } catch (err) {
        alert('Gagal mengakses kamera. Pastikan izin diberikan dan perangkat mendukung kamera.\n\n' + err.message);
        console.error(err);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    startBtn.addEventListener('click', () => startCamera());

    switchBtn.addEventListener('click', async () => {
      usingFacingMode = usingFacingMode === 'user' ? 'environment' : 'user';
      await startCamera();
    });

    // Capture dengan frame tetap
    captureBtn.addEventListener('click', () => {
      if (!video || video.readyState < 2) {
        alert('Kamera belum siap. Tekan "Minta Akses Kamera" lalu tunggu video muncul.');
        return;
      }

      const vw = video.videoWidth || video.clientWidth;
      const vh = video.videoHeight || video.clientHeight;
      if (!vw || !vh) {
        alert('Gagal mendapatkan ukuran video. Coba muat ulang halaman.');
        return;
      }

      canvas.width = vw;
      canvas.height = vh;
      const ctx = canvas.getContext('2d');

      // Mirror horizontal jika kamera depan
      if (usingFacingMode === 'user') {
        ctx.save();
        ctx.translate(vw, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, vw, vh);
        ctx.restore();
      } else {
        ctx.drawImage(video, 0, 0, vw, vh);
      }

      // Gambar frame di atas
      if (currentTemplateImage) {
        ctx.drawImage(currentTemplateImage, 0, 0, vw, vh);
      }

      const dataUrl = canvas.toDataURL('image/png');
      result.src = dataUrl;
      downloadBtn.href = dataUrl;
      downloadBtn.style.display = 'inline-block';
      downloadBtn.textContent = 'Download Foto (PNG)';
    });

    // Matikan kamera saat keluar
    window.addEventListener('pagehide', stopCamera);
    window.addEventListener('unload', stopCamera);
  </script>
</body>
</html>
